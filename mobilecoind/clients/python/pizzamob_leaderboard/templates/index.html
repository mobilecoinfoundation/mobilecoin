<html>
    <head>
        <title>Satoshi's Pizzeria</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/lofi.css') }}">
        <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

        <script src="https://code.jquery.com/jquery-3.5.1.min.js", crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.js", crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="container">
          <div class="center" id="screen">
            <div id="output" class="row"></div>
            <div id="input" class="row">
              <span id="prompt">>&nbsp;</span>
              <input id="cmd" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="cmd"></input>
            </div>
          </div>
        </div>
        <div class="hidden"><input id="code" type="text" value=''></input></div>
    </body>

<script>

var needs_reset = false;
var printing = false;

function getStatus(passphrase) {
  console.log("getting status for: ", passphrase);
  var method = "POST";
  var url = "/add_user";
  var salt = CryptoJS.enc.Utf16.parse("don't oversalt the dough!");
  var hashed_passphrase = CryptoJS.PBKDF2(passphrase, salt, {keySize: 256/32, iterations: 500}).toString(CryptoJS.enc.Hex);
  var data = { player_data: hashed_passphrase };
  return $.ajax({method, url, data}).then(r => {
    var status = JSON.parse(r);
    console.log("status is: ", status);

    // copy request code to clipboard
    $('#code').val(status.code);
    $('#code').focus();
    $('#code').select();
    document.execCommand('copy');

    return status;
  });
};

function getIntroText(passphrase, status) {
  var line = "********************************************************************************";
  var text = line + '\n';
  if (status.new) {
    text += "Your passphrase is unique. Good luck!\n\n";
  } else {
    text += "Welcome back!\n\n";
  }
  text += "Remember your passphrase to claim your pizza: \n\n--> " + passphrase + "\n\n";
  text += "Your request code is: \n\n";
  text += status.code;
  text += "\n\n" ;
  if (status.balance < status.goal){
    text += "You have deposited " + status.balance + " MOB" + ". Deposit 10000 MOB to win.\n\n";
  } else {
    text += "Congratulations! You have won. Send an email to <pizza@mobilecoin.com> with your passphrase to claim your prize.\n\n";
  }
  text += line + '\n\n';
  return text;
};

function getLeaderboardText(status) {
  var line = "********************************************************************************";
  var text = line + '\n\n';
  text += 'LEADING CONTESTANTS:\n\n';
  var found_user = false;
  var rows_printed = 0;
  var max_rows_to_dispay = 15;
  for (var i = 0; i < status.leaderboard.length; i++) {
    var balance = status.leaderboard[i].balance;
    var code = status.leaderboard[i].code;
    var percent = (balance/status.goal*100).toString().split(".")[0] + '%';
    if (status.code === code) {
      found_user = true;
      text += "--> " + code.slice(0, 20) + "...  MOB " + balance + "  [" + percent + "]\n"
      rows_printed++;
    } else if (rows_printed < max_rows_to_dispay) {
      text += "    " + code.slice(0, 20) + "...  MOB " + balance + "  [" + percent + "]\n"
      rows_printed++;
    }
  }
  text += "\n\n" + line;

  return text;
}

function slowWrite(content, prefix="", postfix="") {
  printing = true;
  $("#input").hide();
  $('#prompt').hide(); // hide prompt '> '
  var dfd = $.Deferred();
  var letters = content.split("");
  var current = 0;
  var count = 0;
  var elem = $("#output");
  elem.text(prefix);
  var interval = setInterval(function() {
    if (current < letters.length) {
      var current_letter = letters[current];

      if (current_letter === '\n') {
        count = 0;
      } else {
        count++;
      }
      if (count == 80) {
        count = 0;
        elem.text(elem.text() + current_letter + '\n');
        if (letters[current+1] === " "){
          current++;
        }
      } else {
        elem.text(elem.text() + current_letter);
      }
      current++;
    } else {
      dfd.resolve();
      clearInterval(interval);
      elem.text(elem.text() + postfix);
      printing = false;
      $("#input").show();
      $("input[name=cmd]").val("");
      $("input[name=cmd]").focus();
    }
    // keep the view scrolled down
    var element = document.getElementById("screen");
    element.scrollTop = element.scrollHeight;

  }, 2);

  return dfd.promise();
};

async function resetAll() {
  console.log("reset!");
  needs_reset = false;
  $('#prompt').hide();
  $("#code").val("");
  await slowWrite("Welcome to Satoshi's Pizzeria.\n\nPlease enter a unique passphrase.\n\n");
  $('#prompt').show();
  $("#input").show();
  $("input[name=cmd]").val("");
  $("input[name=cmd]").focus();
}

$(document).keydown(async function(e) {
  var refresh_interval;

  if (printing) {
    e.preventDefault();
    return;
  }

  if (needs_reset) {
    clearInterval(refresh_interval);
    resetAll();
  }
  else {
    key = e.keyCode;
    if(key == 13) { // enter key pressed
      e.preventDefault();

      var passphrase = $("#cmd").val().trim();

      if (passphrase === "") {
        console.log("empty passphrase");
        resetAll();
        return;
      }
      status = await getStatus(passphrase);

      var intro = getIntroText(passphrase, status);
      var leaderboard = getLeaderboardText(status);
      var ending = "Your request code was copied to the clipboard." +
                   "Refreshing in 10 seconds, or press any key to restart...";

      console.log(intro + leaderboard + ending);
      await slowWrite(intro + leaderboard + ending);

      // setup for refresh
      var elapsed_seconds = 0;
      refresh_interval = setInterval(async function() {
        if (elapsed_seconds > 10) {
          status = await getStatus(passphrase);

          await slowWrite(getLeaderboardText(status),
                          prefix=getIntroText(passphrase, status),
                          postfix="Your request code was copied to the clipboard. Press any key to restart...");
          elapsed_seconds = 0;
        } else {
          elapsed_seconds++;
          console.log(elapsed_seconds);
        }
      }, 1);

      $("input[name=cmd]").focus();
      needs_reset = true;
    }
  }
});

$(document).mousedown(function(e) {
  e.preventDefault();
  if ( $("#code").val() ) {
    var code = $("#code").val().match(/.{1,40}/g).join("\n");
    alert("Your request code was copied to the clipboard.\n\n" + code );
  }
  $("input[name=cmd]").focus();
});

resetAll();

</script>

</html>
