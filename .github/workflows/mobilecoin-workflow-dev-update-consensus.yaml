# Copyright (c) 2018-2022 The MobileCoin Foundation
#
# MobileCoin Core projects - Reusable Workflow - update consensus nodes in a development namespace.

name: mobilecoin-workflow-dev-update-consensus

on:
  workflow_call:
    inputs:
      block_version:
        description: "block_version"
        type: string
        required: true
      tokens_json_version:
        description: "The version of the tokens.json file we will generate"
        type: string
        default: '1'
        required: false
      chart_repo:
        description: "Chart Repo URL"
        type: string
        required: false
        default: https://harbor.mobilecoin.com/chartrepo/mobilecoinfoundation-public
      namespace:
        description: "Target Namespace"
        type: string
        required: true
      version:
        description: "release version"
        type: string
        required: true
    secrets:
      FOG_KEYS_SEED:
        description: "(from environment) static wallet seed"
        required: true
      FOG_REPORT_SIGNING_CA_CERT:
        description: "(from environment) Fog Report signing CA cert"
        required: true
      FOG_REPORT_SIGNING_CERT:
        description: "(from environment) Fog Report signing cert pem"
        required: true
      FOG_REPORT_SIGNING_CERT_KEY:
        description: "(from environment) Fog Report signing cert key"
        required: true
      IAS_KEY:
        description: "(from environment) IAS"
        required: true
      IAS_SPID:
        description: "(from environment) IAS"
        required: true
      INITIAL_KEYS_SEED:
        description: "(from environment) static wallet seed"
        required: true
      IP_INFO_TOKEN:
        description: "ipinfo.io token for authenticated access"
        required: true
      LEDGER_AWS_ACCESS_KEY_ID:
        description: "(from environment) Ledger AWS S3 access"
        required: true
      LEDGER_AWS_SECRET_ACCESS_KEY:
        description: "(from environment) Ledger AWS S3 access"
        required: true
      MINTING_1_GOVERNOR_1_PRIVATE:
        description: "(from environment) minting governor key"
        required: true
      MINTING_1_GOVERNOR_1_PUBLIC:
        description: "(from environment) minting governor key"
        required: true
      MINTING_1_SIGNER_1_PRIVATE:
        description: "(from environment) minting governor key"
        required: true
      MINTING_1_SIGNER_1_PUBLIC:
        description: "(from environment) minting governor key"
        required: true
      MINTING_8192_GOVERNOR_1_PRIVATE:
        description: "(from environment) minting governor key"
        required: true
      MINTING_8192_GOVERNOR_1_PUBLIC:
        description: "(from environment) minting governor key"
        required: true
      MINTING_8192_SIGNER_1_PRIVATE:
        description: "(from environment) minting signer key"
        required: true
      MINTING_8192_SIGNER_1_PUBLIC:
        description: "(from environment) minting signer key"
        required: true
      MNEMONIC_FOG_KEYS_SEED:
        description: "(from environment) static wallet seed"
        required: true
      MNEMONIC_KEYS_SEED:
        description: "(from environment) static wallet seed"
        required: true
      POSTGRESQL_FOG_RECOVERY_PASSWORD:
        description: "password for fog_recovery database"
        required: true
      RANCHER_CLUSTER:
        description: "(from environment) Rancher cluster name"
        required: true
      RANCHER_URL:
        description: "(from environment) Rancher server URL"
        required: true
      RANCHER_TOKEN:
        description: "(from environment) Rancher access token"
        required: true

jobs:
  setup-environment:
    uses: ./.github/workflows/mobilecoin-workflow-dev-setup-environment.yaml
    with:
      namespace: ${{ inputs.namespace }}
      block_version: ${{ inputs.block_version }}
      tokens_json_version: ${{ inputs.tokens_json_version }}
      chart_repo: ${{ inputs.chart_repo }}
      version: ${{ inputs.version }}
    secrets: inherit

  consensus-restart:
    runs-on: [self-hosted, Linux, small]
    needs:
    - setup-environment
    environment:
      name: dev
    strategy:
      matrix:
        object_name:
        - deployment.app/consensus-node-1
        - deployment.app/consensus-node-2
        - deployment.app/consensus-node-3
    steps:
    - name: Restart Consensus Nodes
      uses: mobilecoinofficial/gha-k8s-toolbox@v1
      with:
        action: pod-restart
        object_name: ${{ matrix.object_name }}
        namespace: ${{ inputs.namespace }}
        rancher_cluster: ${{ secrets.RANCHER_CLUSTER }}
        rancher_url: ${{ secrets.RANCHER_URL }}
        rancher_token: ${{ secrets.RANCHER_TOKEN }}
