# Copyright (c) 2018-2022 The MobileCoin Foundation
#
# MobileCoin Core projects - Reusable Workflow - Restore dev env to previous release level.

name: mobilecoin-workflow-dev-bootstrap

on:
  workflow_call:
    inputs:
      block_version:
        description: "block_version"
        type: string
        required: true
      chart_repo:
        description: "Chart Repo URL"
        type: string
        required: false
        default: https://harbor.mobilecoin.com/chartrepo/mobilecoinfoundation-public
      namespace:
        description: "Target Namespace"
        type: string
        required: true
      version:
        description: "Chart Version"
        type: string
        required: true
    secrets:
      FOG_KEYS_SEED:
        description: "(from environment) static wallet seed"
        required: true
      FOG_REPORT_SIGNING_CA_CERT:
        description: "(from environment) Fog Report signing CA cert"
        required: true
      FOG_REPORT_SIGNING_CERT:
        description: "(from environment) Fog Report signing cert pem"
        required: true
      FOG_REPORT_SIGNING_CERT_KEY:
        description: "(from environment) Fog Report signing cert key"
        required: true
      IAS_KEY:
        description: "(from environment) IAS"
        required: true
      IAS_SPID:
        description: "(from environment) IAS"
        required: true
      INITIAL_KEYS_SEED:
        description: "(from environment) static wallet seed"
        required: true
      IP_INFO_TOKEN:
        description: "ipinfo.io token for authenticated access"
        required: true
      LEDGER_AWS_ACCESS_KEY_ID:
        description: "(from environment) Ledger AWS S3 access"
        required: true
      LEDGER_AWS_SECRET_ACCESS_KEY:
        description: "(from environment) Ledger AWS S3 access"
        required: true
      MINTING_1_GOVERNOR_1_PRIVATE:
        description: "(from environment) minting governor key"
        required: true
      MINTING_1_GOVERNOR_1_PUBLIC:
        description: "(from environment) minting governor key"
        required: true
      MINTING_1_SIGNER_1_PRIVATE:
        description: "(from environment) minting governor key"
        required: true
      MINTING_1_SIGNER_1_PUBLIC:
        description: "(from environment) minting governor key"
        required: true
      MINTING_8192_GOVERNOR_1_PRIVATE:
        description: "(from environment) minting governor key"
        required: true
      MINTING_8192_GOVERNOR_1_PUBLIC:
        description: "(from environment) minting governor key"
        required: true
      MINTING_8192_SIGNER_1_PRIVATE:
        description: "(from environment) minting governor key"
        required: true
      MINTING_8192_SIGNER_1_PUBLIC:
        description: "(from environment) minting governor key"
        required: true
      MNEMONIC_FOG_KEYS_SEED:
        description: "(from environment) static wallet seed"
        required: true
      MNEMONIC_KEYS_SEED:
        description: "(from environment) static wallet seed"
        required: true
      POSTGRESQL_FOG_RECOVERY_PASSWORD:
        description: "password for fog_recovery database"
        required: true
      RANCHER_CLUSTER:
        description: "(from environment) Rancher cluster name"
        required: true
      RANCHER_URL:
        description: "(from environment) Rancher server URL"
        required: true
      RANCHER_TOKEN:
        description: "(from environment) Rancher access token"
        required: true

jobs:
  reset:
    uses: ./.github/workflows/mobilecoin-workflow-dev-reset.yaml
    with:
      namespace: ${{ inputs.namespace }}
      delete_namespace: true
    secrets: inherit

  restore-s3-archive:
    runs-on: [self-hosted, Linux, small]
    needs:
    - reset
    environment:
      name: dev
    container:
      image: mobilecoin/gha-s3-pg-helper:v0
    steps:
    - name: Restore Ledger Archive from S3
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.LEDGER_AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.LEDGER_AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-central-1
        BUCKET: mobilecoin.eu.development.chain
        NAMESPACE: ${{ inputs.namespace }}
        VERSION: ${{ inputs.version }}
      run: |
        for i in 1 2 3
        do
          aws s3 cp --only-show-errors --recursive --acl public-read \
            s3://${BUCKET}/prebuilt/${VERSION}/chain/node${i} \
            s3://${BUCKET}/node${i}.${NAMESPACE}.development.mobilecoin.com
        done

  setup-environment:
    uses: ./.github/workflows/mobilecoin-workflow-dev-setup-environment.yaml
    needs:
    - reset
    with:
      namespace: ${{ inputs.namespace }}
      block_version: ${{ inputs.block_version }}
      chart_repo: ${{ inputs.chart_repo }}
      version: ${{ inputs.version }}
    secrets: inherit

  #  We now have a db with setup-environment
  #  Note this only works if we are in the same cluster as the dev env.
  restore-db-from-archive:
    runs-on: [self-hosted, Linux, small]
    needs:
    - setup-environment
    environment:
      name: dev
    container:
      image: mobilecoin/gha-s3-pg-helper:v0
    steps:
    - name: restore-db
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.LEDGER_AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.LEDGER_AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-central-1
        BUCKET: mobilecoin.eu.development.chain
        PGDATABASE: postgres
        PGHOST: fog-recovery-postgresql-primary.${{ inputs.namespace }}
        PGPASSWORD: ${{ secrets.POSTGRESQL_FOG_RECOVERY_PASSWORD }}
        PGUSER: postgres
        VERSION: ${{ inputs.version }}
      run: |
        # Copy sql from S3
        aws s3 cp --only-show-errors \
          s3://${BUCKET}/prebuilt/${VERSION}/sql/fog_recovery.sql \
          /tmp/fog_recovery.sql

        # Restore to PG
        psql < /tmp/fog_recovery.sql

