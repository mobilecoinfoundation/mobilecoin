name: Up-rev remote repo submodule and try to build.
description: Pull an outside repo that submodules the current repo, try to up-rev the submodule and see if it still builds.

inputs:
    remoteRepo:
      description: The username/repository-name of the repository to check
      required: true
    id:
      description: A unique identifier for this step
      required: true
    submodulePath:
      description: The path to the submodule we are going to try and up-rev
      required: true
    buildCmd:
      description: The command to build the remote repo
      required: true

runs:
  using: composite
  steps:
  - uses: mobilecoinofficial/gh-actions/checkout@5ec4c64c949162b232d3e33d2649cb8416637d5e
    with:
      repository: ${{ inputs.remoteRepo }}
      path: workdir-${{ inputs.id }}

  - name: Build outside repo with current branch
    shell: bash
    env:
      ID: ${{ inputs.id }}
      SUBMODULE_PATH: ${{ inputs.submodulePath }}
      BUILD_CMD: ${{ inputs.buildCmd }}
    run: |
      set -e
      set -o pipefail

      pushd "workdir-${ID}"

      STATE_DIR="${GITHUB_WORKSPACE}/state-${ID}"
      mkdir -p "${STATE_DIR}"
      CUR_BRANCH="${GITHUB_REF//\//_}""

      # If this file exists, it means we have failed building this branch at least once.
      STATE_FILE="${STATE_DIR}/${CUR_BRANCH}-failed"

      # Attempt to uprev the submodule to the latest revision in the current PR this action is running in

      pushd "${SUBMODULE_PATH}"

      # git remote set-url origin ${{ github.repositoryUrl }} - this is git:// and GHA doesn't seem to like it
      git remote set-url origin "https://github.com/${GITHUB_REPOSITORY}"
      git fetch origin "${GITHUB_REF}:uprev-test"
      git checkout uprev-test
      git log -1 --format='%H'
      cd ..

      ${BUILD_CMD}
