name: Up-rev remote repo submodule and try to build.
description: Pull an outside repo that submodules the current repo, try to up-rev the submodule and see if it still builds.

inputs:
    remoteRepo:
      description: The username/repository-name of the repository to check
      required: true
    id:
      description: A unique identifier for this step
      required: true
    submodulePath:
      description: The path to the submodule we are going to try and up-rev
      required: true
    buildCmd:
      description: The command to build the remote repo
      required: true

runs:
  using: composite
  steps:
  - uses: mobilecoinofficial/gh-actions/checkout@5ec4c64c949162b232d3e33d2649cb8416637d5e
    with:
      repository: ${{ inputs.remoteRepo }}
      path: workdir-${{ inputs.id }}

  - name: Build outside repo with current branch
    shell: bash
    env:
      ID: ${{ inputs.id }}
      SUBMODULE_PATH: ${{ inputs.submodulePath }}
      BUILD_CMD: ${{ inputs.buildCmd }}
    run: |
      set -e
      set -o pipefail

      # Change to remote repo base
      pushd "workdir-${ID}"

      # Change to submodule path under remote repo
      pushd "${SUBMODULE_PATH}"

      # Update submodule to current git ref
      git checkout "${GITHUB_REF}"

      # Back out to remote repo base
      popd

      # Run build command
      ${BUILD_CMD}
